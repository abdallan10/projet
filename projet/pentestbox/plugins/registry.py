import importlib
import pkgutil
import pathlib

from pentestbox.plugins.base import PluginBase

def discover_plugins():
    plugins = {}
    plugins_path = pathlib.Path(__file__).parent
    for finder, name, ispkg in pkgutil.iter_modules([str(plugins_path)]):
        if name == "base" or name == "registry":
            continue
        try:
            module = importlib.import_module(f"pentestbox.plugins.{name}")
            for attr in dir(module):
                obj = getattr(module, attr)
                if (
                    isinstance(obj, type)
                    and issubclass(obj, PluginBase)
                    and obj is not PluginBase
                ):
                    plugin = obj()
                    plugins[plugin.name()] = plugin
        except Exception:
            continue
    return plugins

PLUGINS = discover_plugins()