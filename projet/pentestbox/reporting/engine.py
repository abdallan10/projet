from jinja2 import Environment, FileSystemLoader
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
import os

TEMPLATE_DIR = os.path.join(os.path.dirname(__file__), "templates")

class ReportEngine:
    def __init__(self):
        self.env = Environment(loader=FileSystemLoader(TEMPLATE_DIR))

    def render_report(self, scan_output_file: str, output_file: str, fmt: str):
        summary = self._parse_scan(scan_output_file)
        if fmt == "html":
            template = self.env.get_template("report.html.j2")
            html = template.render(summary=summary)
            with open(output_file, "w") as f:
                f.write(html)
        elif fmt == "pdf":
            template = self.env.get_template("report.html.j2")
            html = template.render(summary=summary)
            # For MVP, simple wrap in PDF
            c = canvas.Canvas(output_file, pagesize=letter)
            text = c.beginText(40, 750)
            text.textLines(html)
            c.drawText(text)
            c.save()
        elif fmt == "csv":
            with open(output_file, "w") as f:
                f.write("key,value\n")
                for k, v in summary.items():
                    f.write(f"{k},{v}\n")

    def _parse_scan(self, scan_output_file: str):
        # MVP: just include the file contents as 'raw'
        if not os.path.exists(scan_output_file):
            return {"raw": "(file missing)"}
        with open(scan_output_file) as f:
            contents = f.read()
        return {"raw": contents}