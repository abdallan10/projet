from pentestbox.core.celery_app import celery_app
from pentestbox.plugins.registry import PLUGINS
from pentestbox.core.audit import audit_event

@celery_app.task(name="pentestbox.tasks.run_scan_task", bind=True)
def run_scan_task(self, module, target, options, output_file, user):
    audit_event(user, "scan_task_started", {"module": module, "target": target, "options": options})
    plugin = PLUGINS.get(module)
    if not plugin:
        audit_event(user, "scan_task_failed", {"err": "Plugin not found"})
        return {"error": "Plugin not found"}
    try:
        result = plugin.scan(target, options, output_file, celery_task=self)
        audit_event(user, "scan_task_finished", {"result": result})
        return {"output_file": output_file, "result": result}
    except Exception as e:
        audit_event(user, "scan_task_failed", {"err": str(e)})
        return {"error": str(e)}