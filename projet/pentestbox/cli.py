import typer
import httpx
import os
import sys

API_URL = os.environ.get("API_URL", "http://localhost:8000")
API_KEY = os.environ.get("API_KEY", "admin-api-key")

app = typer.Typer(help="PenTestBox CLI - Automated Pentest Orchestration")

def api_headers():
    return {"X-API-Key": API_KEY}

@app.command()
def init(target: str = typer.Option(..., help="Target URL or asset identifier")):
    """Initialize a pentest target."""
    r = httpx.post(f"{API_URL}/init", params={"target": target}, headers=api_headers())
    typer.echo(r.json())

@app.command()
def scan(module: str = typer.Option(..., help="Tool module (e.g. nikto, gobuster)"),
         target: str = typer.Option(..., help="Target URL"),
         wordlist: str = typer.Option(None, help="Wordlist (gobuster only)")):
    """Launch a scan via selected module/tool."""
    options = {}
    if wordlist:
        options["wordlist"] = wordlist
    r = httpx.post(
        f"{API_URL}/scan",
        params={"module": module, "target": target},
        json={"options": options},
        headers=api_headers(),
        timeout=120
    )
    typer.echo(r.json())

@app.command()
def report(target: str = typer.Option(..., help="Target asset"),
           scan_output_file: str = typer.Option(..., help="Scan output file"),
           fmt: str = typer.Option("html", help="Format: html|pdf|csv")):
    """Generate a report from pentest run."""
    r = httpx.post(
        f"{API_URL}/report",
        params={"target": target, "scan_output_file": scan_output_file, "fmt": fmt},
        headers=api_headers(),
        timeout=120
    )
    # Save output to file
    if r.status_code == 200:
        out_file = f"{target}_report.{fmt}"
        with open(out_file, "wb") as f:
            f.write(r.content)
        typer.echo(f"Report saved: {out_file}")
    else:
        typer.echo(r.text, err=True)
        sys.exit(1)