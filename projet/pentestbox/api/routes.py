from fastapi import APIRouter, Depends, HTTPException, status, BackgroundTasks
from fastapi.responses import FileResponse
from pentestbox.api.deps import get_current_user
from pentestbox.core.audit import audit_event
from pentestbox.core.celery_app import celery_app
from pentestbox.plugins.registry import PLUGINS
from pentestbox.core.config import settings
from pentestbox.reporting.engine import ReportEngine
import os
import uuid

router = APIRouter()

@router.post("/init")
def api_init_target(target: str, user = Depends(get_current_user)):
    audit_event(user["username"], "init_target", {"target": target})
    # DB target creation omitted for MVP
    return {"status": "ok", "target": target}

@router.post("/scan")
def api_scan(target: str, module: str, options: dict = {}, user=Depends(get_current_user)):
    audit_event(user["username"], "scan_start", {"target": target, "module": module, "options": options})
    if module not in PLUGINS:
        raise HTTPException(status_code=404, detail="Module/plugin not found")
    output_file = f"/tmp/{module}_{uuid.uuid4().hex}.out"
    scan_task = celery_app.send_task(
        "pentestbox.tasks.run_scan_task",
        args=(module, target, options, output_file, user["username"])
    )
    return {"status": "started", "task_id": scan_task.id, "output_file": output_file}

@router.get("/scan/status/{task_id}")
def api_scan_status(task_id: str, user=Depends(get_current_user)):
    async_result = celery_app.AsyncResult(task_id)
    res = {
        "ready": async_result.ready(),
        "status": async_result.status,
        "result": async_result.result if async_result.ready() else None,
    }
    audit_event(user["username"], "scan_status", {"task_id": task_id, "result": res})
    return res

@router.post("/report")
def api_report(target: str, scan_output_file: str, fmt: str = "html", user=Depends(get_current_user)):
    audit_event(user["username"], "gen_report", {"target": target, "fmt": fmt})
    result_path = f"/tmp/report_{uuid.uuid4().hex}.{fmt}"
    rengine = ReportEngine()
    rengine.render_report(scan_output_file, result_path, fmt)
    return FileResponse(result_path, filename=os.path.basename(result_path))

@router.get("/docs")
def docs_redirect():
    from fastapi.responses import RedirectResponse
    return RedirectResponse("/docs")